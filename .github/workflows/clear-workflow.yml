name: 清理 Workflow 历史

on:
  workflow_dispatch:

permissions:
  actions: write

jobs:
  clear-workflows:
    runs-on: ubuntu-latest
    steps:
      - name: Delete all non-running workflow runs
        uses: actions/github-script@v8
        with:
          script: |
            // 获取所有工作流运行记录（处理分页）
            let allRuns = [];
            let page = 1;
            let hasMore = true;

            while (hasMore) {
              const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100,
                page: page
              });
              
              if (runs.workflow_runs.length > 0) {
                allRuns = allRuns.concat(runs.workflow_runs);
                page++;
              } else {
                hasMore = false;
              }
            }

            // 过滤掉运行中的记录
            const runsToDelete = allRuns.filter(run => 
              run.status !== 'in_progress' && 
              run.status !== 'queued' && 
              run.status !== 'waiting'
            );

            console.log(`Found ${allRuns.length} total runs, ${runsToDelete.length} to delete`);

            // 删除符合条件的运行记录
            for (const run of runsToDelete) {
              console.log(`Deleting run ${run.id} (Status: ${run.status}, Workflow: ${run.workflow_ref?.split(':')[1]})`);
              try {
                await github.rest.actions.deleteWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  run_id: run.id
                });
              } catch (error) {
                console.error(`Failed to delete run ${run.id}: ${error.message}`);
              }
            }
